# 多线程介绍

## 一、多线程基础

- 进程与线程
  - 进程: 独立占据一部分计算资源和存储资源的程序
  - 线程: 进程的一部分，它比进程开销小，不同的线程之间共享计算与存储资源
- 并发与并行
  - 并发: 多个共享资源的线程表现得好像是同时运行
  - 并行: 利用CPU的多核特征，不同的进程/线程同时运行在不同的核心上
- 多线程既可以并行也可以并发
- 线程安全问题：当多个线程访问共享资源时可能错误修改数据
- 悲观锁: 当一个线程访问共享资源时对其进行上锁，禁止其它线程访问，操作完成后释放锁
- 线程通信: 多个线程相互交互，如生产者消费者模型
- 生产者消费者模型
  - 生产者生产数据放入共享资源
  - 消费者访问共享资源使用数据
  - 当共享资源仍可添加数据时生产者向其中添加数据，当共享资源中仍存在数据时消费者从中取走数据
- 线程的生命周期: 新生、(就绪)、运行、阻塞、等待、计时等待、死亡
- 线程池: 让一个线程可以执行多次任务，当一个线程执行完任务后进入就绪状态直到下一个任务到来，从而减少开销

## 二、多线程创建

- 继承Thread类，重写run()方法

    ```Java
    // 线程类
    public class MyThread extends Thread {
        public void run() {
            for (int i=0; i<5; i++) {
                System.out.println("子线程MyThread输出：" + i);
            }
        }
    }
    // 主程序
    public class ThreadTest {
        public static void main() {
            Thread t1 = new MyThread(name:"T1");
            Thread t2 = new MyThread(name:"T2");
            t1.start();     //start()启动线程，并执行任务
            t2.start();
        }
    }
    ```

- 实现Runnable接口，实现run()方法
  - 步骤: 定义实现Runnable接口的任务类，用任务类对象作为构造函数参数创建Thread类对象，调用start()方法
  - 示例:

    ```Java
    // 任务类
    public class Task implements Runnable {
        public void run() {
            for (int i=0; i<5; i++) {
                System.out.println("子线程MyThread输出：" + i);
            }
        }
    }
    // 主程序
    public class ThreadTest {
        public static void main() {
            Runnable task = new Task();
            new Thread(task).start();
            new Thread(task).start();
        }
    }
    ```

  - 匿名内部类实现  

    ```Java
    // 主程序
    public class ThreadTest {
        public static void main() {
            Runnable task = new Runnable() {
                public void run() {
                    for (int i=0; i<5; i++) {
                        System.out.println("子线程MyThread输出：" + i);
                    }
                }
            };
            new Thread(task).start();
            new Thread(task).start();
        }
    }
    ```

  - 函数式接口实现

    ```Java
    // 主程序
    public class ThreadTest {
        public static void main() {
            new Thread(()->{
                    for (int i=0; i<5; i++) {
                        System.out.println("子线程MyThread输出：" + i);
                    }
                }).start();
            new Thread(()->{
                    for (int i=0; i<5; i++) {
                        System.out.println("子线程MyThread输出：" + i);
                    }
                }).start();
        }
    }
    ```

- Callable<>接口，使用FutureTask<>封装得到任务类对象
  - 传入与返回参数
    - 使用任务类的构造函数传入参数
    - 实现Callable<>接口的call()方法，使用FutureTask<>类的get方法得到调用call()得到的返回参数
  - 使用步骤
    - 定义实现Callable<>接口的任务类，把Callable<>对象封装为FutureTask<>对象，将FutureTask<>对象封装成Thread对象，调用start()方法
    - 调用FutureTask<>对象的get()方法可得到run()方法的结果，get()方法是一个阻塞方法
  - 示例

    ```Java
    // 任务类
    public class Task implements Callable<String> {
        private String message;

        public Task(String message) {
            this.message = message;
        }

        public String call() {
            for (int i=0; i<3; i++) {
                System.out.println(Thread.currentThread.getName() + "输出消息: " + message);
            }
            return message;
        }
    }

    // 主程序
    public class ThreadTest {
        public static void main() {
            Task task1 = new Task("重要的事情说三遍");
            Task task2 = new Task("论文一定会中");
            FutureTask<String> f1 = new FutureTask<>(task1);
            FutureTask<String> f2 = new FutureTask<>(task2);
            new Thread(f1).start();
            new Thread(f2).start();
            System.out.println("f1输出：" + f1.get());
            System.out.println("f2输出：" + f2.get());
        }
    }
    ```

- Thread类支持的方法
  - 主线程: 主程序所在的线程
  - 构造函数
    |Thread类的常见构造函数                      |说明                                  |
    |:-:                                        |:-:                                  |
    |public Thread(String name)                 |为当前线程指定名称                    |
    |public Thread(Runnable target)             |封装Runnable对象为线程对象            |
    |public Thread(Runnable target, String name)|封装Runnable对象为线程对象,并指定名称  |
  - 实例方法与静态方法
    |方法                                       |说明                                   |
    |:-:                                        |:-:                                   |
    |public run()                               |线程执行的任务                         |
    |public void start()                        |启动线程,等待调度                      |
    |public String getName()                    |自定义名称或默认名称                   |
    |public void setName(String name)           |自定义名称                             |
    |public static Thread currentThread()       |获取当前线程对象                       |
    |public static void sleep(long time)        |当前线程休眠time毫秒,可能触发异常      |
    |public final void join()                   |调用方法的线程执行完                   |

## 三、悲观锁

