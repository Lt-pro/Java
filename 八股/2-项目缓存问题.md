## 项目缓存问题描述

论坛项目在服务端使用Caffine+Redis构建了一个二级缓存结构来缓存用户和帖子详情数据，用于减轻DB端访问压力、降低请求时延、提高整体并发能力。

其中Caffine用于构建一个服务端本地缓存，旨在节省服务端和Redis的通信开销。

**数据一致性问题**

当有多台服务器时，同一份数据不同服务器甚至DB存储的数据会出现不一致的问题。

如A、B两台服务器同时缓存一个帖子信息，A首先请求帖子写入Redis缓存和本地缓存，此时有一个请求修改DB存储帖子信息并删除Redis缓存，B再请求帖子信息并写入Redis缓存和本地缓存，此时再有一个请求更改DB，则会出现A、B、DB同一帖子数据不一致，Redis中没有缓存数据的问题。


## 数据一致性问题解决思路

**过期时间+版本号**

问题的关键在于如何保证多份本地副本与DB中存储数据相同，这里参考了HTTP中的强制缓存和协商缓存解决方案。

- 当本地请求数据时，我们额外附上一个较短的过期时间；查询本地数据时判断数据是否过期，若未过期则继续使用本地缓存，否则请求最新版本数据。
- 在请求数据时，除了过期时间外还额外附加一个版本号；当判断本地数据过期时，请求最新数据时带上版本号，若版本号相同，说明可以继续使用数据，返回一个新的过期时间，否则返回最新版本的数据。


### 在过期时间内数据被更改了怎么办？

设置较小的过期时间只能保证大于过期时间的数据是一致的，但不能解决过期时间内DB数据被更改导致的不一致问题。这里考虑使用**消息队列**作为解决方案。

为多个本地端、DB建立一个频道；DB作为生产者，当有数据被更改就向频道发布一条消息；本地端作为消费者消费消息即可。这样数据不一致时间可以缩小到消息传递到消费者处理的时间，问题在于Redis的更新策略该如何写，从消息队列来看Redis和本地端是同一层级的。


### 缓存数据还是存在一定数据不一致时间？

从业务角度考虑，缓存允许一定不一致时间的数据，其他数据强制走DB。或者对业务逻辑进行调整


## 服务端二级缓存结构合理吗？

**不合理**

服务端二级缓存引入的问题比解决的问题要多。服务端本地缓存通常节省的网络开销，如果服务端的集群比较近或者带宽足够大，这一般不成问题；服务器通常是作为集群进行部署的，为了保证二级缓存的数据一致性需要做很多额外的工作；此外，完全可以将**数据缓存在用户端**，利用之间的数据一致性策略解决不一致问题。


## 缓存穿透问题？

当有大量请求同时访问某一个数据，此时该条数据恰好过期则会出现缓存穿透问题。此时可以考虑**分布式锁**，当有多个请求发现数据过期时会尝试抢占分布式锁，抢占成功的请求从DB中读取数据，失败的请求则被阻塞，直到下一次查询缓存数据或者再次抢占锁。

### 分布式锁可能导致大量请求堆积？

由于只有一个请求能抢占锁，其它请求会阻塞导致，存在连接池被打爆的风险。对于未抢占到锁的请求，令它返回**null值或者已经过期的值**，当客户端发现得到的是null值或过期值，则等待一会重新发送请求。


